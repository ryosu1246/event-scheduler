# グループ機能で追加されたデータベーステーブル

## 概要

グループ機能の実装に伴い、以下の2つのテーブルが新規作成されました。
また、既存の `events` テーブルに外部キー制約が追加されました。

---

## 1. `groups` テーブル（新規作成）

### 目的
グループ（チーム・組織）の情報を管理するためのテーブル。

### なぜ必要か
- 複数のユーザーがグループを作成し、グループ単位でイベントを管理できるようにするため
- イベントを特定のグループに紐づけることで、メンバー間での共有・閲覧制限を実現するため

### テーブル構造

| カラム名 | 型 | 説明 |
|---------|------|------|
| id | bigint (PK) | 主キー |
| name | varchar(255) | グループ名 |
| description | text (nullable) | グループの説明文 |
| icon_path | varchar(255) (nullable) | アイコン画像のパス |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

### 使用される機能
- グループ作成・編集・削除
- グループ一覧表示
- グループアイコン設定

### マイグレーションファイル
`database/migrations/2025_11_20_000001_create_groups_table.php`

---

## 2. `group_user_roles` テーブル（新規作成）

### 目的
ユーザーとグループの関係（多対多）を管理する中間テーブル。
各ユーザーのグループ内での役割（ロール）も保持する。

### なぜ必要か
- 1人のユーザーが複数のグループに所属できる
- 1つのグループに複数のユーザーが所属できる
- この「多対多」の関係を表現するには中間テーブルが必要
- さらに、ユーザーの役割（管理者/メンバー/招待中）を区別するため

### テーブル構造

| カラム名 | 型 | 説明 |
|---------|------|------|
| id | bigint (PK) | 主キー |
| user_id | bigint (FK) | usersテーブルへの外部キー |
| group_id | bigint (FK) | groupsテーブルへの外部キー |
| role | enum('admin', 'member', 'invited') | 役割 |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

**制約**
- `UNIQUE(user_id, group_id)` - 同一ユーザーが同一グループに重複登録されることを防止
- `user_id` - usersテーブルへの外部キー（CASCADE削除）
- `group_id` - groupsテーブルへの外部キー（CASCADE削除）

### 役割（role）の意味

| 値 | 説明 |
|------|------|
| admin | グループ管理者。編集・削除・招待などの管理権限を持つ |
| member | 一般メンバー。イベントの閲覧・回答が可能 |
| invited | 招待中。まだ承認していないユーザー |

### 使用される機能
- グループへのユーザー招待
- 招待の承認/拒否
- メンバー一覧表示
- メンバー削除
- 権限チェック（管理者のみ実行可能な操作の制御）

### マイグレーションファイル
`database/migrations/2025_11_20_000002_create_group_user_roles_table.php`

---

## 3. `events` テーブル（修正）

### 変更内容
既存の `group_id` カラムに対して以下の変更を実施。

| 変更項目 | 変更前 | 変更後 |
|---------|-------|-------|
| NULL許可 | nullable | NOT NULL |
| 外部キー | なし | groupsテーブルへのFK（CASCADE削除） |

### なぜ必要か
- すべてのイベントが必ずグループに所属する設計に変更
- グループ削除時に関連イベントも自動削除されるようにするため

### データ移行処理
マイグレーション実行時に以下の処理を自動実行：
1. `group_id = NULL` のイベントを持つユーザーごとに「個人」グループを自動作成
2. そのユーザーを管理者として登録
3. 該当イベントの `group_id` を更新

### マイグレーションファイル
`database/migrations/2025_11_20_000003_add_foreign_key_and_migrate_events.php`

---

## ER図（簡易版）

```
┌──────────────┐       ┌───────────────────┐       ┌──────────────┐
│    users     │       │  group_user_roles │       │    groups    │
├──────────────┤       ├───────────────────┤       ├──────────────┤
│ id (PK)      │──┐    │ id (PK)           │    ┌──│ id (PK)      │
│ name         │  └───>│ user_id (FK)      │    │  │ name         │
│ email        │       │ group_id (FK)     │<───┘  │ description  │
│ ...          │       │ role              │       │ icon_path    │
└──────────────┘       └───────────────────┘       └──────────────┘
                                                          │
                                                          │ 1:N
                                                          ▼
                                                   ┌──────────────┐
                                                   │    events    │
                                                   ├──────────────┤
                                                   │ id (PK)      │
                                                   │ title        │
                                                   │ group_id(FK) │
                                                   │ ...          │
                                                   └──────────────┘
```

---

## ポートフォリオとしての評価

### 適切である理由

| 観点 | 評価 |
|------|------|
| **設計の妥当性** | 多対多リレーションを中間テーブルで実現するのはRDBの基本的かつ正しいアプローチ |
| **実務での一般性** | グループ・チーム機能は多くのWebアプリで見られる一般的な機能 |
| **権限管理** | roleカラムによる権限分離は実務でも広く使われるパターン |
| **データ整合性** | 外部キー制約・CASCADE削除により、データの整合性を担保 |
| **拡張性** | roleをenum型にすることで、将来的な役割追加も容易 |

### 実務で評価されるポイント

1. **正規化の理解**
   - 中間テーブルによる多対多の実現は、データベース正規化の理解を示す

2. **外部キー制約の活用**
   - アプリケーションレベルだけでなく、DB層でもデータ整合性を担保

3. **マイグレーションでのデータ移行**
   - 既存データを壊さずに新機能を追加する実践的なスキル

4. **権限管理の実装**
   - role（admin/member/invited）による認可制御は実務で必須のスキル

### 結論

**ポートフォリオとして非常に適切**

この設計は、開発実務未経験者でも以下を理解していることを示せる：
- リレーショナルデータベースの基本概念
- 多対多リレーションの正しい実装方法
- 権限管理（認可）の基本的な考え方
- マイグレーションによる段階的なスキーマ変更

むしろ、単純なCRUDだけのアプリよりも、グループ・権限管理を含むアプリの方がポートフォリオとして差別化できる。
